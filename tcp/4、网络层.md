<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [网络层](#%E7%BD%91%E7%BB%9C%E5%B1%82)
  - [为什么需要网络层](#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E7%BD%91%E7%BB%9C%E5%B1%82)
  - [网络层的设计思路](#%E7%BD%91%E7%BB%9C%E5%B1%82%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF)
  - [⽹际协议 IP](#%E2%BD%B9%E9%99%85%E5%8D%8F%E8%AE%AE-ip)
    - [虚拟互联网络](#%E8%99%9A%E6%8B%9F%E4%BA%92%E8%81%94%E7%BD%91%E7%BB%9C)
    - [分类 IP 地址](#%E5%88%86%E7%B1%BB-ip-%E5%9C%B0%E5%9D%80)
    - [划分子网](#%E5%88%92%E5%88%86%E5%AD%90%E7%BD%91)
      - [1、节省 IP 地址资源，提高 IP 地址的利用率；](#1%E8%8A%82%E7%9C%81-ip-%E5%9C%B0%E5%9D%80%E8%B5%84%E6%BA%90%E6%8F%90%E9%AB%98-ip-%E5%9C%B0%E5%9D%80%E7%9A%84%E5%88%A9%E7%94%A8%E7%8E%87)
      - [2、给每一个物理网络分配一个网络号会使得路由表变得太大因为网络性能变差](#2%E7%BB%99%E6%AF%8F%E4%B8%80%E4%B8%AA%E7%89%A9%E7%90%86%E7%BD%91%E7%BB%9C%E5%88%86%E9%85%8D%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E5%8F%B7%E4%BC%9A%E4%BD%BF%E5%BE%97%E8%B7%AF%E7%94%B1%E8%A1%A8%E5%8F%98%E5%BE%97%E5%A4%AA%E5%A4%A7%E5%9B%A0%E4%B8%BA%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD%E5%8F%98%E5%B7%AE)
      - [3、减少广播所带来的负面影响](#3%E5%87%8F%E5%B0%91%E5%B9%BF%E6%92%AD%E6%89%80%E5%B8%A6%E6%9D%A5%E7%9A%84%E8%B4%9F%E9%9D%A2%E5%BD%B1%E5%93%8D)
    - [子网掩码](#%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81)
      - [1、声明网络地址与主机地址](#1%E5%A3%B0%E6%98%8E%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E4%B8%8E%E4%B8%BB%E6%9C%BA%E5%9C%B0%E5%9D%80)
      - [2、划分子网](#2%E5%88%92%E5%88%86%E5%AD%90%E7%BD%91)
    - [无类型域间选路（CIDR）](#%E6%97%A0%E7%B1%BB%E5%9E%8B%E5%9F%9F%E9%97%B4%E9%80%89%E8%B7%AFcidr)
  - [参考](#%E5%8F%82%E8%80%83)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 网络层

### 为什么需要网络层 

网络层是为传输层提供服务的，为了向传输层提供服务，网络层必须使用数据链路层提供的服务。  

而数据链路层的主要作用是负责解决两个直接相邻节点之间的通信，但并不负责解决数据经过通信子网中多个转接节点时的通信问题。  

因此，网络层需要实现两个端系统之间的数据透明传送，让源端的数据能够以最佳路径透明地通过通信子网中的多个转接节点到达目的端，使得传输层不必关心网络的拓扑构型以及所使用的通信介质和交换技术。   

### 网络层的设计思路

网络层向上只提供简单灵活的，无连接的、尽最大努力交付的数据报服务。   

由于传输⽹络不提供端到端的可靠传输服务，⽹络中的路由器可以做得⽐较简单，⽽且价格低廉：  

- 如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由⽹络的主机中的运输层负责可靠交付（包括差错处理、流量控制等）；  

- 这种设计思路的好处是：⽹络的造价⼤⼤降低，运⾏⽅式灵活，适应多种应⽤。  

数据报服务无连接  

<img src="/img/ip/ip-network-connect.jpg"  alt="tcp" /> 

### ⽹际协议 IP

⽹际协议 IP 是 `TCP/IP` 体系中两个最主要的协议之⼀。     

与 IP 协议配套使⽤的还有三个协议：   

1、地址解析协议 ARP； 

2、⽹际控制报⽂协议 ICMP； 

3、⽹际组管理协议 IGMP。   

<img src="/img/ip/ip-network-ip.jpg"  alt="tcp" /> 

#### 虚拟互联网络

如果要把在全世界数以百万计的网络都互相连接起来，并且能够相互通信，是一件很复杂的事情。  

网络技术是不断发展的。网络的制造厂家也要经常要推出新的网络，在竞争中求生存，因此在市场上总是有很多不同性能、不同网络协议的网络。  

将⽹络互相连接起来要使⽤⼀些中间设备。中间设备⼜称为中间系统或中继 (relay)系统。      

有下面五种中间设备：   

1、物理层中继系统：转发器 (repeater，中继器)；   

2、数据链路层中继系统：⽹桥 或 桥接器 (bridge)；   

3、⽹络层中继系统：路由器 (router)；   

4、⽹桥和路由器的混合物：桥路器 (brouter)；   

5、⽹络层以上的中继系统：⽹关 (gateway)。

互联网与虚拟互联网  

实际的互联网是通过一些路由器连接的，由于参与互联的计算机网络都使用相同的网际 IP 协议，因此可以把互联以后的网络看成是一个虚拟互联网络。  

<img src="/img/ip/ip-network-virtual.jpg"  alt="tcp" /> 

所谓虚拟互连⽹络也就是逻辑互连⽹络：   

- IP 协议可以使这些性能各异的⽹络从⽤户看起来好像是⼀个统⼀的⽹络；   

- 使⽤ IP 协议的虚拟互连⽹络可简称为 IP ⽹。  

使⽤虚拟互连⽹络的好处是：  

- 当互联⽹上的主机进⾏通信时，就好像在⼀个⽹络上通 信⼀样，⽽看不⻅互连的各具体的⽹络异构细节。    

来看下分组在互联网中的传递  

<img src="/img/ip/ip-network-deliver.jpg"  alt="tcp" /> 

整个互联网就是一个单一的，抽象的网络。IP 地址就是给互联网中上的每一台主机(或路由器)的每一个接口分配的一个在全世界范围内唯一的32位的标识符。   

IP 地址由互联⽹名字和数字分配机构`ICANN (Internet Corporation for Assigned Names and Numbers)`进⾏分配。   

#### 分类 IP 地址

分类 IP 地址：就是将 IP 地址划分成若干个分类，每一类地址都有两个固定长度的字段组成。

第一个字段是网络号：标志着主机（或路由器）所连接的网络，一个网络号在整个互联网中是唯一的。

第二个字段是主机号：主机号用于识别该网络中的主机。一台主机号在它前面的网络号做指定的网络的范围内必须是唯一的。

所以网络号的唯一，加上主机号在网络号中的唯一，可以得出 IP 地址在整个互联网内是唯一的。

`IP 地址：={<网络号>，<主机号>}`

分类 IP 地址在设计的过程中，前面一部分是网络号，后面一部分是主机号。

<img src="/img/ip/ip-class.jpg"  alt="tcp" />   

对于主机和路由器来来说，IP 地址都是 32 位的二进制代码，但是这样可读性不好，所以引入了**点分十进制记法**。

点分十进制记法：为了提高可读性，尝尝把 32 位的 IP 地址中每 8 位插入一个空格（机器中是没有这样的空格）。同时用等效的十进制数字表示，同时加入一个点。

<img src="/img/ip/ip-class-1.jpg"  alt="tcp" />   

知道了如何分类，我们就能算出 IP 地址的指派范围

<img src="/img/ip/ip-class-2.jpg"  alt="tcp" />     

#### 划分子网

为什么需要划分子网，划分子网的作用和意义？

##### 1、节省 IP 地址资源，提高 IP 地址的利用率；

划分子网之后，其实是减少了能连接在网络中的主机数，但是却说提高了 IP 地址的利用率，可能有点歧义，这里举个栗子，来分析下

加入某个学校有四个机房，每个机房30台机器，如果不划分子网，那就很简单，申请 4 个 C 类地址，一个个机房配置下就行了，这样做就造成一部分 IP 的浪费。

我们知道 C 类地址的最大主机数是254，那么这样使用下来，每个机房只用到了30个IP,一共造成了 4*(256-30) 个 IP 的浪费。如果大家都这样操作的话，那么 Internet 上的 IP 地址早就枯竭了。

划分子网之后

只需要申请一个 C 类地址，然后划分成 4 个子网，这样可以满足需求了

##### 2、给每一个物理网络分配一个网络号会使得路由表变得太大因为网络性能变差

每一个路由器都应当能够从路由表中查出应怎样到达其它网络的下一跳路由器，因此互联网中的网络数越多，路由器路由表中的项目数也就越多，这样会使整个路由器和互联网的性能下降。

##### 3、减少广播所带来的负面影响

减少广播所带来的负面影响，提高性能的整体性能。因为广播数据包只能在同一网段中传输，通过划分子网，网络规模小了，网络中用户数少了，当然所占用的资源也就少了。

#### 子网掩码

子网掩码是一个32位地址，是与IP地址结合使用的一种技术。它的主要作用有两个，一是用于屏蔽IP地址的一部分以区别网络标识和主机标识，并说明该IP地址是在局域网上，还是在远程网上。二是用于将一个大的IP网络划分为若干小的子网络。

##### 1、声明网络地址与主机地址

子网掩码是一个32位地址：

对于A类地址来说，默认的子网掩码是 `255.0.0.0`；

对于B类地址来说默认的子网掩码是 `255.255.0.0`；

对于C类地址来说默认的子网掩码是 `255.255.255.0`。

将32位的子网掩码与IP地址进行二进制形式的按位逻辑“与”运算得到的便是网络地址；

将子网掩码二进制的非的结果和IP地址二进制进行逻辑“与”（AND）运算，得到的就是主机地址。

子网掩码的规则：

用户连续的1对应网络号和子网号；

用连续的0对应主机号，得到32位的二进制；

##### 2、划分子网

上面我们讨论了划分子网的意义，子网掩码就可以帮助我们对子网进行划分。

其作用是：减少网络上的通信量；节省IP地址；便于管理；解决物理网络本身的某些问题。使用子网掩码划分子网后，子网内可以通信，跨子网不能通信，子网间通信应该使用路由器，并正确配置静态路由信息。

子网划分结构的规则。就是用连续的1在IP地址中增加表示网络地址，同时减少表示主机地址的位数。

#### 无类型域间选路（CIDR）

分类 IP 地址的划分还是有点不科学，比如 c 类地址，同一个网络下面只有 254 个主机，显然是有点少了，B 类地址中，同一个网络中可以放65534台主机，这显然有点多了，一般企业达不到这样的规模。

可以不可以按需分配IP地址呢，需要多少个就分配多少个。

所以有了一个折中的方式叫作无类型域间选路，简称 CIDR。

无类型域间选路（CIDR）打破了原来设计中的几类地址的做法，将 32 位的 IP 地址一分为二，**前面是网络号，后面是主机号**。

<img src="/img/ip/ip-classs-5.jpg"  alt="tcp" />   

栗如：`10.100.122.2/24`

这个 IP 地址中有一个斜杠，斜杠后面有个数字 24。这种地址表示形式，就是 CIDR。后面 24 的意思是，32 位中，前 24 位是网络号，后 8 位是主机号。

CIDR 的优点：

1、使用变长的"网络前缀"(network-prefix)来替代分类中的网络号和主机号，IP 地址从三级编址(使用子网掩码)又回到了两级编制。

2、可以将网络前缀相同的连续IP地址组成"CIDR地址块"，一个"CIDR地址块"可以表示很多地址，这种地址的聚合成为路由聚合，也称为构成超网。在互联网中，只要有可能，就显示为一个聚合的网络，路由聚合减少了路由器之间的路由选择信息交换，提高了整个互联网的性能；

3、可以更加有效的分配IPv4地址空间，通过分配适大小的CIDR地址块，按需分配IP地址呢，需要多少个就分配多少个。





### 参考

【极客时间-趣谈网络协议】https://time.geekbang.org/column/intro/100007101  
【计算机网络第八版】https://www.bilibili.com/video/BV1WP4y1j7JU?p=1  
【计算机网络学习笔记】https://github.com/boilingfrog/Go-POINT/tree/master/tcp     


