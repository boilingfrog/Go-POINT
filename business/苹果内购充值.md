<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [苹果内购](#%E8%8B%B9%E6%9E%9C%E5%86%85%E8%B4%AD)
  - [前言](#%E5%89%8D%E8%A8%80)
  - [苹果内购](#%E8%8B%B9%E6%9E%9C%E5%86%85%E8%B4%AD-1)
  - [设计方案](#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88)
  - [参考](#%E5%8F%82%E8%80%83)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 苹果内购

### 前言

接触公司的充值业务很久了,在处理苹果充值的时候也踩了很多的坑，这里就花时间来总结下。

### 苹果内购

IAP 全称：`In-App Purchase`，是指苹果 `App Store` 的应用内购买，是苹果为 App 内购买虚拟商品或服务提供的一套交易系统。

为什么这里着重来介绍 IAP 呢，因为 IAP 和微信支付和支付宝支付的实现逻辑不太一样，因为 IAP 支付依赖 IOS 客户端调用异步支付回调接口，进行用户和订单的绑定，会有丢单的情况产生，这里
假定大家对苹果支付有一定了解了，重点主要是来聊下苹果支付的技术实现方案。

聊下，目前 IAP 中充值我们遇到的问题点

1、丢单；

2、订单充值到错误的账号；

3、在苹果设置中直接点击充值，导致不到账。

### 苹果支付的难点  

关于苹果充值的难点，这边总结下来就是下面两点：   

1、如何处理订单回执和用户账号的绑定关系；   

2、APP 中复杂的网络环境，如何保证订单能够成功回调；

### 方案设计

下面来介绍下苹果支付中需要特别关注的点。  

#### 1、商品设计

#### 2、用户和回执的绑定

苹果支付中，苹果回调中的是没有第三方订单信息的，所以，苹果订单回执信息和用户的绑定需要在 APP 中完成。  

苹果充值成功，给到 IOS 客户端充值的回调信息，然后客户端需要把当前的回执信息和当前的用户做好绑定，上报数据到自己的服务端，进行订单校验和充值道具的下发。     

处理处理的时候，每一笔订单都会生成唯一的订单号。用户和回执信息的绑定，也就是，订单号和用户回执信息的绑定，因为订单对应数据，里面会关联用户信息。  

这样用户和回执的绑定也就回归到用户订单和苹果回执的绑定，那么订单号在何时生成，如何和苹果回执做绑定呢？有两种方案，下面来一一探讨下。   

1、生成订单 -> 发起 iap 充值 -> 绑定订单id和 iap 充值的回调信息；  

2、发起 iap 充值 -> 接收到回调信息 -> 回调信息校验通过，生成对应的订单信息。     







#### 3、回调的重试







### 参考


