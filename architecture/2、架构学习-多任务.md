<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [架构学习-多任务：进程，线程，协程](#%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E5%8D%8F%E7%A8%8B)
  - [参考](#%E5%8F%82%E8%80%83)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 架构学习-多任务：进程，线程，协程

### 多任务

多任务处理：是指计算机同时运行多个程序的能力。比如说，我们在使用电脑的时候，可以边听音乐，边写文档。    

从物理层面上看，最早的 CPU 都是单核的，也就是同一时间只能执行一条指令。   

单核 CPU 是如何支持多任务处理的呢？方法是把 CPU 切成一段段的时间片，每个时间片只运行某一个软件。多任务的一般方法运行第一个程序的一段代码，保存工作环境；在运行第二个程序的一段代码，保存环境；恢复第一个程序的工作环境，执行第一个程序的下的一段代码...现代的多任务，每个程序的时间分配相对平均。   

每个时间片，只运行某一个软件，因为时间片很小，我们会感觉这些软件在同时运行。这种多时间分片实现的多任务系统，我们称之为分时系统。   

那么这个任务指的是什么呢？从今天的现实看，任务的抽象并不是唯⼀的。⼤部分操作系统提供了两套：进程和线程。有的 操作系统还会提供第三套叫协程。   

来看下这几个的区别  

|     执行体      |        地址空间         |      调度方    |      时间片调度    |      主动调度    |                
|     进程        |不同的执行体有不同的地址空间|   操作系统内核  |     基于时钟中断   |   系统调用syscall |
|     线程        |不同的执行体共享地址空间   |   操作系统内核  |     基于时钟中断   |   系统调用syscall |
|     协程        |不同的执行体共享地址空间   |   用户态       |     一般不支持     |   包装系统调用     |

这里着重来了解下协程  

协程是一种比线程更加轻量的执行体，协程完全有程序控制(在用户态执行)，能够带来性能的大幅度提升。  

一个操作系统中可以有多个进程；一个进程可以有多个线程；同理，一个线程可以有多个协程。   

协程的存在能够高效的利用线程，减少线程的创建。为什么需要减少线程的数量呢，因为线程创建的成本比较高。   

线程的时间成本：  

1、执行体切换本身的开销，主要是寄存器保存和回复的成本；  

2、执行体的调度开销，主要是如何在大量已准备好的执行体中选出谁获得执行权；  

3、执行体之间的同步互斥成本。   

线程的空间成本：    

1、执行体的执行状态；  

2、TLS(线程局部存储)；  

3、执行体的堆栈。   

默认情况下，Linux 中线程数量在数 MB 左右，最大的成本是堆栈(虽然堆栈的大小可以设置的，但是处于线程执行的安全考虑，线程的堆栈不能太小)，假定一个线程 1MB，那么 1000 个线程的大小就到了 GB 级别了，消耗还是很大的。   

协程的存在能够降低执行体的空间和时间成本。   

一个完备的协程库可以理解成用户态的操作线程，而协程就是用户态中的线程。  

有两个语言实现了完整的协程库，GO 语言和 Erlang 语言。Go 语言里面的用户态"进程"叫 goroutine。有下面的一些设计：  

1、堆栈开始很小(只有4k),可以按需增长；  

2、干掉了"线程局部存储(TLS)"特性的支持，执行体更加精简；  

3、提供了同步，互斥和其他常规执行体的通讯手段，比如 channel；  

4、提供了几乎所有重要的系统调用(尤其是IO请求)的包装。   

操作系统所有涉及系统调用的方法都在内核空间，包括磁盘读写，内存分配回收，网络接口读写，都是 web 应用巨频繁使用的。  




 





### 参考

【多任务处理】https://zh.wikipedia.org/wiki/%E5%A4%9A%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86  
【面向对象编程】https://www.liaoxuefeng.com/wiki/1016959663602400/1017495723838528      
【许式伟的架构课】https://time.geekbang.org/column/article/89668  