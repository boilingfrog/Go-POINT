<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [消息模型](#%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B)
  - [消息队列的演进](#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E6%BC%94%E8%BF%9B)
    - [消息队列模型](#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%A8%A1%E5%9E%8B)
    - [发布订阅模型](#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%9E%8B)
  - [RabbitMQ的消息模型](#rabbitmq%E7%9A%84%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B)
    - [交换器的类型](#%E4%BA%A4%E6%8D%A2%E5%99%A8%E7%9A%84%E7%B1%BB%E5%9E%8B)
    - [direct](#direct)
  - [参考](#%E5%8F%82%E8%80%83)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 消息模型

### 消息队列的演进

#### 消息队列模型

早起的消息队列是按照"队列"的数据结构来设计的。   

生产者（Producer）产生消息，进行入队操作，消费者（Consumer）接收消息，就是出队操作，存在于服务端的消息容器就称为消息队列。   

<img src="/img/mq-queue.png"  alt="mq" align="center" />

当然消费者也可能不止一个，存在的多个消费者是竞争的关系，消息被其中的一个消费者消费了，其它的消费者就拿不到消息了。    

#### 发布订阅模型

如果一个人消息想要同时被多个消费者消费，那么上面的队列模式就不适用了，于是又引出了一种新的模式，发布订阅模型。   

<img src="/img/mq-pubsub.png"  alt="mq" align="center" />

在发布-订阅模型中，消息的发送方称为发布者（Publisher），消息的接收方称为订阅者（Subscriber），服务端存放消息的容器称为主题（Topic）。  

发布者发送消息到主题中，然后订阅者需要先订阅主题。订阅主题的订阅者之后就可以收到发送者发送的消息了。    

发布订阅也是兼容消息队列模型的，如果只有一个订阅者，就是消息队列模型了。    

### RabbitMQ的消息模型

RabbitMQ 使用的还是消息队列这种消息模型，不过它引入了一个 exchange 的概念。  
 
exchange 也就是交换器，位于生产者和队列之间，生产者产生的数据是直接发送到 exchange 中，然后 exchange 根据配置的策略将消息发送到对应的队列中。   

<img src="/img/mq-rabbitmq-exchange.png"  alt="mq" align="center" />

RabbitMQ 中通过绑定将交换器和队列关联起来，绑定的时候一般会指定一个绑定键(BindingKey)。   

生产者发送消息的时候会指定一个 RoutingKey ,当 RoutingKey 和 BindingKey，一样的时候就会被发送的对应的队列中去。    

#### 交换器的类型

RabbitMQ 中肠常用的交换器有 `fanout、direct、topic、headers` 四种，这里来一一分析下   

#### direct

direct 会根据发送消息的 RoutingKey ，然后发送到和 RoutingKey 匹配的 BindingKey 对应的队列中去。    

<img src="/img/mq-direct.png"  alt="mq" align="center" />

如果发送消息的路由键也就是 RoutingKey，为 info 的时候，两个消息队列都会收到消息，如果路由键为 debug ，exchange 只会把消息发送到消息队列1中。   

### 参考

【消息队列高手课】https://time.geekbang.org/column/intro/100032301     
【消息队列设计精要】https://tech.meituan.com/2016/07/01/mq-design.html    


