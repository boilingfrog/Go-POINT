## 什么是内网穿透

### 内网穿透

什么是内网穿透呢？  

百度百科的描述

> 内网穿透，也即 NAT 穿透，进行 NAT 穿透是为了使具有某一个特定源 IP 地址和源端口号的数据包不被 NAT 设备屏蔽而正确路由到内网主机。  

简单来说内网穿透的目的是：让外网能访问你本地的应用，例如在外网打开你本地http://127.0.0.1指向的Web站点。   

### 工作方式

网络地址转换（Network Address Translation，NAT）机制的问题在于，NAT设备自动屏蔽了非内网主机主动发起的连接，也就是说，从外网发往内网的数据
包将被NAT设备丢弃，这使得位于不同NAT设备之后的主机之间无法直接交换信息。这一方面保护了内网主机免于来自外部网络的攻击，另一方面也为P2P通信带来了
一定困难。Internet上的NAT设备大多是地址限制圆锥形NAT或端口限制圆锥形 NAT，外部主机要与内网主机相互通信，必须由内网主机主动发起连接，使 NAT设
备产生一个映射条目，这就有必要研究一下内网穿透技术。  

#### 通信的一方处于内网

两台主机进行通信，一方有公网ip，一方没有  

一台主机有一个公网 IP，另一台主机有一个内网 IP

![channel](/img/nat_1.png?raw=true)

我们假定Client:A有内网ip，Client:B有公网ip。  

Client:A处于NAT之后，拥有ip(10.0.0.1:8080),Client:B位于 NAT 之前，并拥有IP(138.76.29.7:8080)，NAT拥有公网 IP 155.99.25.11。  
Client:B有公网ip，所以Client:A可以直接通过TCP连接到(138.76.29.7:8080)，但是如果Client:B连接Client:A则会连接不成功，会找不到Client:A。
此时，需要一个公有的服务器辅助进行内网穿透。Client A 和 Client B 向服务器发起登陆请求，并保持一个 TCP 或 UDP 连接，服务器记录其 IP 地址和端口号，
这里服务器对 Client A 是记录其经过 NAT 映射之后的 IP 和端口号。当 Client B 想连接 Client A 时，首先向服务器提出请求，服务器在收到请求后向
 Client A 发出打洞命令，并将 Client B 的[IP 地址：端口]对发给 Client A，Client A 根据接收到的 IP地址和端口号向 Client B 发起 TCP 连接
 或发送 UDP 数据包。接下来 Client A 和Client B 之间便可以建立数据传输通道。  

#### 通信的双方都处于内网

两台主机进行通信，双方处在内网中  

![channel](/img/nat_2.png?raw=true)














### 参考
【一分钟实现内网穿透（ngrok服务器搭建）】https://www.cnblogs.com/best/p/7465444.html  