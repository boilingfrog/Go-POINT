<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [数据库中阻塞语句的查询和分析](#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%98%BB%E5%A1%9E%E8%AF%AD%E5%8F%A5%E7%9A%84%E6%9F%A5%E8%AF%A2%E5%92%8C%E5%88%86%E6%9E%90)
  - [前言](#%E5%89%8D%E8%A8%80)
  - [MySQL](#mysql)
    - [1、使用 show processlist](#1%E4%BD%BF%E7%94%A8-show-processlist)
  - [参考](#%E5%8F%82%E8%80%83)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 数据库中阻塞语句的查询和分析

### 前言

MySQL 阻塞是指在并发访问 MySQL 数据库时，某个事务占用了资源并且长时间不释放，导致其他事务无法执行或执行缓慢的情况。  

MySQL 阻塞可能会导致数据库性能下降，甚至出现死锁等问题，需要马上进行处理。    
 
在 MySQL中，线程阻塞可能是由于以下原因导致：   

1、锁冲突：如果两个或者多个线程同时请求同一个资源(栗如：同一行或者同一个表)，其中一个将被阻塞，直到其他线程释放锁；   

2、长事务：如果一个事务占用锁的时间过长，可能会导致其它事务长时间等待甚至是超时；   

3、死锁：如果两个线程或者更多的线程相互等待对方的资源，将会发生死锁(Deadlock)，进而导致语句的执行阻塞。      

如何排查和定位阻塞语句呢，下面来分析下？    

### MySQL  

面对阻塞的语句如何查看呢？  

首先我们来模拟2个阻塞的场景，然后使用命令来排查定位。    

准备数据   

````
CREATE TABLE `t_user` (
  `id` int(11) NOT NULL,
  `name` varchar(16) NOT NULL,
  `age` int(11) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB;

insert into t_user values(1,  "小明",12);
insert into t_user values(2, "小红",20);
insert into t_user values(3, "小白",19);
insert into t_user values(4, "张三",24);
insert into t_user values(5, "李四",25);
insert into t_user values(6, "王五",26);
````

模拟长事务的场景   

事务 1  

```
SET autocommit = 0;
begin;
UPDATE t_user SET age=12  WHERE id=1;
select SLEEP(12000);
commit;
```

事务 2  

```
SET autocommit = 0;
begin;
UPDATE t_user SET age=13  WHERE id=1;
commit;
```

两个事务，第一个事务更新语句对 `id=1` 这一行加了行锁，同时这个事务 sleep 了 120 秒。事务2同样更新 `id=1` 这一行数据，也会加一把行锁，因为事务 1 的 sleep，导致事务 1 的行锁没有释放，事务 2 就处于阻塞中了。   

下面来看下如何排查  

#### 1、使用 show processlist  

`show processlist` 显示的是正在运行的线程，root 用户或者有 PROCESS 权限的用户能执行这个查询。    

`show processlist` 显示的信息都是来自 MySQL 系统库 information_schema 中的 processlist 表。也可以直接查询这个。   

```
Select * from information_schema.processlist；   
```

```
$ show processlist;

+----+------+------------------+--------------------+---------+------+------------+--------------------------------------+
| Id | User | Host             | db                 | Command | Time | State      | Info                                 |
+----+------+------------------+--------------------+---------+------+------------+--------------------------------------+
|  7 | root | 172.21.0.1:56974 | test               | Query   |    3 | updating   | UPDATE t_user SET age=13  WHERE id=1 |
|  8 | root | 172.21.0.1:56976 | information_schema | Query   |    0 | starting   | show processlist                     |
|  9 | root | 172.21.0.1:56978 | test               | Query   | 2120 | User sleep | select SLEEP(12000)                  |
+----+------+------------------+--------------------+---------+------+------------+--------------------------------------+
```

来看下 `show processlist` 中几个参数的含义：   

- Id：线程的标识，如果该线程幼有问题，可以直接通过 `kill <Id>`，杀死该线程；   

- User：启动这个线程的用户；  

- Host: 客户端 IP 和端口号。结合 `ss -n | grep :<port>` 命令，可以定位到是哪个进程发送的请求；   

- db：当前执行的命令是在哪个数据库；   

- Command：显示正在执行的命令，常见的有休眠（sleep），查询（query），连接（connect）等，更多的可参见官方文档[Thread Command Values](https://dev.mysql.com/doc/refman/8.0/en/thread-commands.html);  

- Time：表示这个状态持续的时间，单位是秒；   

- State：表示当前执行 sql 语句的状态,例如 executing 表示开始执行语句，`Rolling back` 表示线程正在回滚事务。更多的可参见官方文档[ General Thread States](https://dev.mysql.com/doc/refman/8.0/en/general-thread-states.html)；    

- Info：显示的是正在执行的 sql 语句，不过这个只能显示前100个字符，要看全部的执行 sql，可使用 `show full processlist` 。    

下面列举几个常用的查询分析栗子  

按客户端 IP 分组，看哪个客户端的链接数最多  

```
select
  client_ip, count(client_ip) as client_num
from
	(select 
	substring_index(host, ':', 1) as client_ip
  from 
	information_schema.processlist) as connect_info
group by client_ip order by client_num desc;

+------------+------------+
| client_ip  | client_num |
+------------+------------+
| 172.21.0.1 |          1 |
+------------+------------+
```

查询正在执行的 sql,根据时间倒叙查询，查询执行时间较长的 sql   

```
select
   * 
from 
   information_schema.processlist 
where 
   Command != 'Sleep' 
	 order by Time desc;
```


### 参考

【mysql阻塞怎么处理】https://juejin.cn/s/mysql%E9%98%BB%E5%A1%9E%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86     
【mysql线程阻塞】https://juejin.cn/s/mysql%E7%BA%BF%E7%A8%8B%E9%98%BB%E5%A1%9E     
【mysql: show processlist 详解】https://zhuanlan.zhihu.com/p/30743094     